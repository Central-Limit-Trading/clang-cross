# Amazon Linux 2 system package configuration
# Applicable to: Amazon Linux 2 (amzn/2)

# Check if sudo is needed (usually runs as root in Docker containers)
SUDO_CMD=""
if [ "$(id -u)" -ne 0 ]; then
    SUDO_CMD="sudo"
fi

# Amazon Linux 2 uses yum
PKG_MANAGER="yum"
PKG_UPDATE_CMD="timeout 120 ${SUDO_CMD} yum check-update || true"
PKG_INSTALL_CMD="${SUDO_CMD} yum install -y"

# List of packages to install
PACKAGES=(
    # Build tools
    "ca-certificates"
    "curl"
    "diffutils"
    "file"
    "git"
    "make"
    "patch"
    "pkgconfig"
    "python3"
    "python3-pip"
    "tar"
    "unzip"
    "wget"
    "which"
    "xz"
    "zlib-devel"
    # Amazon Linux 2 specific: gcc10 for LLVM (requires GCC >= 7.4)
    # Default GCC 7.3.1 does not meet the requirement
    "gcc10"
    "gcc10-c++"
    "gcc10-binutils"
    # Note: ninja-build package (1.7.2) is too old, will install via pip3
)

# System-specific additional configuration commands (optional)
EXTRA_SETUP_COMMANDS=()

# GCC version requirement
# LLVM requires GCC >= 7.4
# Amazon Linux 2's default GCC is 7.3.1, which does NOT meet the requirement
# Create symbolic links to make gcc10 the default compiler and binutils
EXTRA_SETUP_COMMANDS+=(
    # Create symbolic links to make gcc10 the default compiler
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-gcc /usr/bin/gcc'
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-g++ /usr/bin/g++'
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-c++ /usr/bin/c++'
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-cpp /usr/bin/cpp'
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-gcc /usr/bin/cc'
    # Create symbolic links for binutils tools
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-ar /usr/bin/ar'
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-ranlib /usr/bin/ranlib'
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-nm /usr/bin/nm'
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-objcopy /usr/bin/objcopy'
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-objdump /usr/bin/objdump'
    '${SUDO_CMD} ln -sf /usr/bin/gcc10-strip /usr/bin/strip'
)

# CMake and Ninja version requirements
# LLVM requires CMake >= 3.20.0 and Ninja >= 1.10
# Amazon Linux 2's cmake3 is 3.17.5 and ninja-build is 1.7.2, both too old
# Install the latest versions via pip3
EXTRA_SETUP_COMMANDS+=(
    # Install the latest CMake and Ninja via pip3
    '${SUDO_CMD} python3 -m pip install --upgrade pip'
    '${SUDO_CMD} python3 -m pip install cmake ninja'
    # Ensure pip-installed tools are in PATH (before /usr/bin)
    'export PATH=/usr/local/bin:$PATH'
    'echo "Using GCC $(gcc --version | head -1)"'
    'echo "Using CMake $(cmake --version | head -1)"'
    'echo "Using Ninja $(ninja --version)"'
)

