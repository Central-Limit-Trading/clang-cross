# RHEL/CentOS/Fedora system package configuration (generic version)
# Applicable to: RHEL, CentOS, Fedora, Rocky Linux, AlmaLinux
# Note: Amazon Linux 2 and Alibaba Cloud Linux 3 have dedicated configuration files

# Check if sudo is needed (usually runs as root in Docker containers)
SUDO_CMD=""
if [ "$(id -u)" -ne 0 ]; then
    SUDO_CMD="sudo"
fi

# Detect whether to use yum or dnf
if command -v dnf &> /dev/null; then
    PKG_MANAGER="dnf"
    PKG_UPDATE_CMD="timeout 120 ${SUDO_CMD} dnf check-update || true"
    PKG_INSTALL_CMD="${SUDO_CMD} dnf install -y"
else
    PKG_MANAGER="yum"
    PKG_UPDATE_CMD="timeout 120 ${SUDO_CMD} yum check-update || true"
    PKG_INSTALL_CMD="${SUDO_CMD} yum install -y"
fi

# List of packages to install
PACKAGES=(
    # Build tools
    "ca-certificates"
    "cmake"
    "curl"
    "diffutils"
    "file"
    "gcc"
    "gcc-c++"
    "git"
    "make"
    "ninja-build"
    "patch"
    "pkgconfig"
    "python3"
    "unzip"
    "wget"
    "which"
    "xz"
    "zlib-devel"
)

# System-specific additional configuration commands (optional)
EXTRA_SETUP_COMMANDS=()

# CMake version requirement
# LLVM requires CMake >= 3.13.4
# Check if system cmake meets the requirement, if not, install via pip3
EXTRA_SETUP_COMMANDS+=(
    'CMAKE_VERSION=$(cmake --version 2>/dev/null | head -1 | grep -oP "\d+\.\d+\.\d+" || echo "0.0.0")'
    'if [ "$(printf "%s\n3.13.4\n$CMAKE_VERSION" | sort -V | head -1)" != "3.13.4" ]; then'
    '    echo "CMake version $CMAKE_VERSION is too old (need >= 3.13.4), installing via pip3..."'
    '    '"${SUDO_CMD}"' python3 -m pip install cmake'
    '    export PATH=/usr/local/bin:$PATH'
    'else'
    '    echo "CMake version $CMAKE_VERSION is sufficient"'
    'fi'
)

