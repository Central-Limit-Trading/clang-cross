# CentOS 7 system package configuration
# Applicable to: CentOS 7 (centos/7)

# Check if sudo is needed (usually runs as root in Docker containers)
SUDO_CMD=""
if [ "$(id -u)" -ne 0 ]; then
    SUDO_CMD="sudo"
fi

# CentOS 7 uses yum
PKG_MANAGER="yum"
PKG_UPDATE_CMD="timeout 120 ${SUDO_CMD} yum check-update || true"
PKG_INSTALL_CMD="${SUDO_CMD} yum install -y"

MIRROR_SETUP_COMMANDS=(
    "${SUDO_CMD} sed -i -e 's|mirrorlist=|#mirrorlist=|g' -e 's|#baseurl=http://mirror.centos.org|baseurl=https://mirrors.aliyun.com|g' /etc/yum.repos.d/CentOS-*.repo"
    "${SUDO_CMD} yum clean all"
    "${SUDO_CMD} yum makecache"
    "${SUDO_CMD} yum install -y epel-release centos-release-scl centos-release-scl-rh"
    "${SUDO_CMD} bash -c 'cat > /etc/yum.repos.d/CentOS-SCLo-scl.repo <<EOF
[centos-sclo-sclo]
name=CentOS-7 - SCLo sclo
baseurl=http://vault.centos.org/7.9.2009/sclo/\\\$basearch/sclo/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo
EOF'"
    "${SUDO_CMD} bash -c 'cat > /etc/yum.repos.d/CentOS-SCLo-scl-rh.repo <<EOF
[centos-sclo-rh]
name=CentOS-7 - SCLo rh
baseurl=http://vault.centos.org/7.9.2009/sclo/\\\$basearch/rh/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo
EOF'"
    # 重新生成缓存
    "${SUDO_CMD} yum clean all"
    "${SUDO_CMD} yum makecache fast"
)

# List of packages to install
PACKAGES=(
    # Build tools
    "ca-certificates"
    "curl"
    "diffutils"
    "file"
    "git"
    "make"
    "patch"
    "pkgconfig"
    "python3"
    "python3-pip"
    "tar"
    "unzip"
    "wget"
    "which"
    "xz"
    "zlib-devel"
    # CentOS 7 specific: devtoolset-11 for modern GCC (LLVM requires GCC >= 5.1)
    "devtoolset-11-gcc"
    "devtoolset-11-gcc-c++"
    "devtoolset-11-binutils"
)

# System-specific additional configuration commands (optional)
EXTRA_SETUP_COMMANDS=()

# Enable devtoolset-11 by default
# LLVM requires GCC >= 5.1, CentOS 7's default GCC is 4.8.5
# Create symbolic links to make devtoolset-11 gcc the default
EXTRA_SETUP_COMMANDS+=(
    # Create symbolic links to make devtoolset-11 gcc the default
    '${SUDO_CMD} ln -sf /opt/rh/devtoolset-11/root/usr/bin/gcc /usr/local/bin/gcc'
    '${SUDO_CMD} ln -sf /opt/rh/devtoolset-11/root/usr/bin/g++ /usr/local/bin/g++'
    '${SUDO_CMD} ln -sf /opt/rh/devtoolset-11/root/usr/bin/c++ /usr/local/bin/c++'
    '${SUDO_CMD} ln -sf /opt/rh/devtoolset-11/root/usr/bin/cpp /usr/local/bin/cpp'
)

# CentOS 7's cmake3 is 3.17.5, but LLVM requires >= 3.20.0
# CentOS 7's ninja-build is 1.10.2, which meets LLVM's >= 1.10 requirement
# Install newer CMake via pip3 to meet LLVM requirements
EXTRA_SETUP_COMMANDS+=(
    '${SUDO_CMD} python3 -m pip install --upgrade pip'
    '${SUDO_CMD} python3 -m pip install cmake ninja'
    'export PATH=/usr/local/bin:$PATH'
    'echo "Using GCC $(gcc --version | head -1)"'
    'echo "Using CMake $(cmake --version | head -1)"'
    'echo "Using Ninja $(ninja --version)"'
)

